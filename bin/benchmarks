#!/usr/bin/env ruby
# frozen_string_literal: true

require "pry"
require "benchmark"

require_relative "../lib/universalid"
require_relative "../test/models"

@count = 10_000
@pad = 98

def run(label)
  Benchmark.benchmark Benchmark::CAPTION, 52, Benchmark::FORMAT, "Average" do |x|
    time = x.report(label) { @count.times { yield } }
    [time / @count.to_f]
  end
  puts "".ljust(@pad, ".")
end

# seed data ..................................................................................................
campaign = Campaign.new(name: "Example Campaign", description: "Example Description", trigger: "Sign Up")
campaign.emails << campaign.emails.build(subject: "First Email", body: "Welcome", wait: 1.day)
campaign.emails << campaign.emails.build(subject: "Second Email", body: "Follow Up", wait: 1.week)
campaign.emails << campaign.emails.build(subject: "Third Email", body: "Hard Sell", wait: 2.days)
campaign.save!

# setup ......................................................................................................
param = campaign.to_packable.to_gid_param
signed_param = campaign.to_packable.to_sgid_param
hash = campaign.as_json
hash_with_options = hash.merge(packable_hash_options: {except: [:trigger, :wait]})
packable_hash = campaign.to_packable(except: [:trigger, :wait])
packable_hash_id = packable_hash.id

# benchmarks .................................................................................................
puts "".ljust(@pad, "=")
puts "Benchmarking #{@count} iterations"
puts "".ljust(@pad, "=")

# PackableHash ...............................................................................................
run("PackableHash.new") { UniversalID::PackableHash.new(hash) }
run("PackableHash.new w/ options") { UniversalID::PackableHash.new(hash_with_options) }
run("PackableHash.find") { UniversalID::PackableHash.find(packable_hash_id) }
run("PackableHash#id") { packable_hash.id }
run("PackableHash#to_gid") { packable_hash.to_gid }
run("PackableHash#to_gid_param") { packable_hash.to_gid_param }
run("PackableHash#to_sgid") { packable_hash.to_sgid }
run("PackableHash#to_sgid_param") { packable_hash.to_sgid_param }

# ActiveModel ..............................................................................................
run("ActiveModelSerializer.from_packable") { Campaign.from_packable(param) }
run("ActiveModelSerializer.from_packable (signed)") { Campaign.from_packable(signed_param) }
run("ActiveModelSerializer#to_packable.to_gid_param") { campaign.to_packable.to_gid_param }
run("ActiveModelSerializer#to_packable.to_sgid_param") { campaign.to_packable.to_sgid_param }
